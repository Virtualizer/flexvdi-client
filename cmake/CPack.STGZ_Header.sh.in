#!/bin/sh

# Display usage
cpack_usage()
{
  cat <<EOF
Usage: $0 [options]
Options:
  --help            print this message
  --prefix=dir      directory in which to install
EOF
  exit 1
}

cpack_echo_exit()
{
  echo $1
  exit 1
}

# Display version
cpack_version()
{
  echo "@CPACK_PACKAGE_NAME@ Installer Version: @CPACK_PACKAGE_VERSION@" \
    ", Copyright (c) @CPACK_PACKAGE_VENDOR@"
}

# Helper function to fix windows paths.
cpack_fix_slashes ()
{
  echo "$1" | sed 's/\\/\//g'
}

# cpack_skip_license=FALSE
cpack_uninstall=FALSE
for a in "$@CPACK_AT_SIGN@"; do
  if echo $a | grep "^--prefix=" > /dev/null 2> /dev/null; then
    cpack_prefix_dir=`echo $a | sed "s/^--prefix=//"`
    cpack_prefix_dir=`cpack_fix_slashes "${cpack_prefix_dir}"`
  fi
  if echo $a | grep "^--help" > /dev/null 2> /dev/null; then
    cpack_usage
  fi
  if echo $a | grep "^--version" > /dev/null 2> /dev/null; then
    cpack_version
    exit 2
  fi
  if echo $a | grep "^--uninstall" > /dev/null 2> /dev/null; then
    cpack_uninstall=TRUE
  fi
#   if echo $a | grep "^--skip-license" > /dev/null 2> /dev/null; then
#     cpack_skip_license=TRUE
#   fi
done

# take the archive portion of this file and pipe it to tar
# the NUMERIC parameter in this command should be one more
# than the number of lines in this header file
# there are tails which don't understand the "-n" argument, e.g. on SunOS
# OTOH there are tails which complain when not using the "-n" argument (e.g. GNU)
# so at first try to tail some file to see if tail fails if used with "-n"
# if so, don't use "-n"
use_new_tail_syntax="-n"
tail $use_new_tail_syntax +1 "$0" > /dev/null 2> /dev/null || use_new_tail_syntax=""

get_tar()
{
    tail $use_new_tail_syntax +###CPACK_HEADER_LENGTH### "$0" | gunzip
}

cpack_version
echo "This is a self-extracting archive."
toplevel="/usr/local"
if [ "x${cpack_prefix_dir}x" != "xx" ]
then
  toplevel="${cpack_prefix_dir}"
fi

if [ "x${cpack_uninstall}x" = "xFALSEx" ]; then
    echo "The archive will be extracted to: ${toplevel}"

    if [ "x${cpack_skip_license}x" = "xFALSEx" ]
    then
    echo ""
    echo "If you want to stop extracting, please press <ctrl-C>."

    if [ "x${cpack_skip_license}x" != "xTRUEx" ]
    then
        more << '____cpack__here_doc____'
@CPACK_RESOURCE_FILE_LICENSE_CONTENT@
____cpack__here_doc____
        echo
        echo "Do you accept the license? [yN]: "
        read line leftover
        case ${line} in
        y* | Y*)
            cpack_license_accepted=TRUE;;
        *)
            echo "License not accepted. Exiting ..."
            exit 1;;
        esac
    fi
    fi

    echo "Extracting, please wait..."
    echo ""

    get_tar | (cd "${toplevel}" && tar xf - --no-same-owner) \
        || cpack_echo_exit "Problem unpacking the @CPACK_PACKAGE_FILE_NAME@"

    echo "Unpacking finished successfully"

    # Post-install
    if [ -d /etc/systemd/system ]; then
        SERVICE=flexvdi-guest-agent.service
        SERVICE_DIR="${toplevel}/share/flexvdi-guest-agent"
        systemctl stop ${SERVICE} > /dev/null 2> /dev/null
        systemctl disable ${SERVICE} > /dev/null 2> /dev/null
        sed -i "s;/usr/local;${toplevel};" "${SERVICE_DIR}/${SERVICE}"
        ln -s "${SERVICE_DIR}/${SERVICE}" /etc/systemd/system
        systemctl daemon-reload
        systemctl start ${SERVICE}
    fi

    ln -s ${toplevel}/libexec/flexvdi-guest-agent/flexvdiprint /usr/lib/cups/backend
    lpadmin -p flexvdiprinter -D "flexVDI PDF Printer" -E -v flexvdiprint: \
        -P ${toplevel}/share/flexvdi-guest-agent/flexvdips.ppd
    lpadmin -d flexvdiprinter

else
    # Pre-uninstall
    systemctl stop flexvdi-guest-agent.service > /dev/null 2> /dev/null
    systemctl disable flexvdi-guest-agent.service > /dev/null 2> /dev/null

    lpadmin -x flexvdiprinter
    rm -f /usr/lib/cups/backend/flexvdiprint

    get_tar | tar tf - | (cd "${toplevel}" && xargs -d '\n' rm -f) \
        || cpack_echo_exit "Problem uninstalling @CPACK_PACKAGE_FILE_NAME@"

    echo "Uninstalling finished successfully"
fi

exit 0
#-----------------------------------------------------------
#      Start of TAR.GZ file
#-----------------------------------------------------------;

