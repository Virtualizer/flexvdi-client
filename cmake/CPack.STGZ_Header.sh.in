#!/bin/sh

exec 3>&1 > /dev/null 2> /dev/null
_echo() {
    echo "$@" >&3
}

# Display usage
cpack_usage()
{
  cat <<EOF >&3
Usage: $0 [options]
Options:
    --help            print this message
    --version         show version
    --uninstall       remove the program
EOF
  exit 1
}

cpack_echo_exit()
{
  _echo $1
  exit 1
}

# Display version
cpack_version()
{
  _echo
  _echo "flexVDI Guest Tools v@CPACK_PACKAGE_VERSION@ Setup"
  _echo "Copyright (c) @CPACK_PACKAGE_VENDOR@ 2015"
  _echo
}

# Helper function to fix windows paths.
cpack_fix_slashes ()
{
  echo "$1" | sed 's/\\/\//g'
}

# cpack_skip_license=FALSE
cpack_uninstall=FALSE
for a in "$@CPACK_AT_SIGN@"; do
  if echo $a | grep "^--help"; then
    cpack_usage
  fi
  if echo $a | grep "^--version"; then
    cpack_version
    exit 2
  fi
  if echo $a | grep "^--uninstall"; then
    cpack_uninstall=TRUE
  fi
#   if echo $a | grep "^--skip-license"; then
#     cpack_skip_license=TRUE
#   fi
done

# take the archive portion of this file and pipe it to tar
# the NUMERIC parameter in this command should be one more
# than the number of lines in this header file
# there are tails which don't understand the "-n" argument, e.g. on SunOS
# OTOH there are tails which complain when not using the "-n" argument (e.g. GNU)
# so at first try to tail some file to see if tail fails if used with "-n"
# if so, don't use "-n"
use_new_tail_syntax="-n"
tail $use_new_tail_syntax +1 "$0" || use_new_tail_syntax=""

get_tar()
{
    tail $use_new_tail_syntax +###CPACK_HEADER_LENGTH### "$0" | gunzip
}

cpack_version
toplevel="@CMAKE_INSTALL_PREFIX@"

if [ "x${cpack_uninstall}x" = "xFALSEx" ]; then
    _echo "The archive will be extracted to: ${toplevel}"

    if [ "x${cpack_skip_license}x" = "xFALSEx" ]
    then
    _echo ""
    _echo "If you want to stop extracting, please press <ctrl-C>."

    if [ "x${cpack_skip_license}x" != "xTRUEx" ]
    then
        more << '____cpack__here_doc____'
@CPACK_RESOURCE_FILE_LICENSE_CONTENT@
____cpack__here_doc____
        echo
        _echo "Do you accept the license? [yN]: "
        read line leftover
        case ${line} in
        y* | Y*)
            cpack_license_accepted=TRUE;;
        *)
            _echo "License not accepted. Exiting ..."
            exit 1;;
        esac
    fi
    fi

    _echo "Extracting, please wait..."

    get_tar | (cd "${toplevel}" && tar xf - --no-same-owner) \
        || cpack_echo_exit "Problem unpacking the @CPACK_PACKAGE_FILE_NAME@"

    _echo "Unpacking finished successfully"

    # Post-install
    if which semodule; then
        _echo
        _echo "Installing SELinux policy"
        semodule -i "${toplevel}/share/selinux/targeted/flexvdi-guest-agent.pp"
        semanage fcontext -a -t flexvdi_exec_t "${toplevel}/bin/flexvdi-guest-agent"
        restorecon "${toplevel}/bin/flexvdi-guest-agent"
    fi

    if which systemctl; then
        SERVICE=flexvdi-guest-agent.service
        SERVICE_DIR="${toplevel}/lib/systemd/system"
        systemctl stop ${SERVICE}
        systemctl disable ${SERVICE}
        rm -f /var/run/flexvdi_pipe
        systemctl enable ${SERVICE}
        systemctl start ${SERVICE}
    else
        [-x /etc/init.d/flexvdi-guest-agent] && /etc/init.d/flexvdi-guest-agent stop
        cp "${toplevel}/libexec/flexvdi-guest-agent/flexvdi-guest-agent.sh" \
           /etc/init.d/flexvdi-guest-agent
        /etc/init.d/flexvdi-guest-agent start
    fi

    if which lpadmin; then
        _echo
        _echo "Installing CUPS backend and filter"
        lpadmin -x flexvdiprinter
        chmod 700 ${toplevel}/libexec/flexvdi-guest-agent/flexvdiprint
        ln -s ${toplevel}/libexec/flexvdi-guest-agent/flexvdiprint /usr/lib/cups/backend
        ln -s ${toplevel}/libexec/flexvdi-guest-agent/pdftopdf-nocopies /usr/lib/cups/filter
        lpadmin -p flexvdiprinter -D "flexVDI PDF Printer" -E -v flexvdiprint: \
            -L "flexVDI Client" -P ${toplevel}/share/flexvdi-guest-agent/flexvdips.ppd
        lpadmin -d flexvdiprinter
    fi

else
    # Pre-uninstall
    systemctl stop flexvdi-guest-agent.service
    systemctl disable flexvdi-guest-agent.service
    rm -f /var/run/flexvdi_pipe

    lpadmin -x flexvdiprinter
    rm -f /usr/lib/cups/backend/flexvdiprint

    if sestatus; then
        _echo
        _echo "Uninstalling SELinux policy"
        semodule -r "${toplevel}/share/selinux/targeted/flexvdi-guest-agent.pp"
    fi

    get_tar | tar tf - | (cd "${toplevel}" && xargs -d '\n' rm -f) \
        || cpack_echo_exit "Problem uninstalling @CPACK_PACKAGE_FILE_NAME@"

    _echo "Uninstalling finished successfully"
fi

exit 0
#-----------------------------------------------------------
#      Start of TAR.GZ file
#-----------------------------------------------------------;

