!define WINLOGON_KEY "SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"

!macro installGina
    ${If} ${RunningX64}
        File "win64/credentials-manager/gina/flexVDIGina.dll"
    ${Else}
        File "win32/credentials-manager/gina/flexVDIGina.dll"
    ${EndIf}
    Rename /REBOOTOK $INSTDIR\flexVDIGina.dll $SYSDIR\flexVDIGina.dll
    ReadRegStr $0 HKLM "${UNINSTALL_KEY}" "OldGinaDLL"
    IfErrors 0 oldgina_present
        ReadRegStr $0 HKLM "${WINLOGON_KEY}" "GinaDLL"
        WriteRegStr HKLM "${UNINSTALL_KEY}" "OldGinaDLL" "$0"
    oldgina_present:
    WriteRegStr HKLM "${WINLOGON_KEY}" "GinaDLL" "flexVDIGina.dll"
    DetailPrint "GINA hook installed"
!macroend

!macro uninstallGina
    ReadRegStr $0 HKLM "${UNINSTALL_KEY}" "OldGinaDLL"
    IfErrors 0 oldgina_present
        StrCpy $0 "msgina.dll"
    oldgina_present:
    FindFirst $1 $2 $SYSDIR\$0
    IfErrors 0 oldgina_noexists
        StrCpy $0 "msgina.dll"
    oldgina_noexists:
    WriteRegStr HKLM "${WINLOGON_KEY}" "GinaDLL" "$0"
    Delete /REBOOTOK $SYSDIR\flexVDIGina.dll
    DetailPrint "GINA hook removed"
!macroend
